name: Build macOS (Apple Silicon) .app with Nuitka

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-macos-arm:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"   # 可按需改成 3.11 / 3.9

      - name: Show python info
        run: |
          uname -a
          python -V
          python -c "import platform, sys; print(platform.platform(), sys.maxsize>2**32 and '64-bit' or '32-bit')"

      - name: Install dependencies + Nuitka
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # 安装 requirements（如果没有 requirements.txt，这行会被忽略）
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 安装 Nuitka 与需要的编译工具的 Python 插件（使用较新稳定版本）
          pip install nuitka==1.8.8 wheel
          # 如果你的项目需要 tkinter，Nuitka 的 tkinter 插件会启用；其他插件也可按需添加
          python -m nuitka --version || true

      - name: Build standalone executable with Nuitka (optimized)
        env:
          # 禁止 TK 警告（若使用 tkinter）
          TK_SILENCE_DEPRECATION: "1"
        run: |
          set -e
          # 清理上次构建
          rm -rf build dist build_nuitka tmp_dist || true

          # 使用 Nuitka 编译为 standalone 目录（--standalone 生成包含所有依赖的目录）
          # 启用 LTO/优化，使用 clang（mac runner 自带 clang）
          python -m nuitka \
            --standalone \
            --follow-imports \
            --output-dir=tmp_dist \
            --remove-output \
            --show-progress \
            --jobs=2 \
            --clang \
            --lto=yes \
            --assume-yes-for-downloads \
            --enable-plugin=tk-inter \
            main.py

          # Nuitka 会在 tmp_dist 下生成 main.dist（或以脚本名为前缀的 .dist）
          ls -l tmp_dist || true
          # 找到 distdir
          DISTDIR=$(ls -1d tmp_dist/*.dist | head -n1)
          echo "DISTDIR=$DISTDIR"
          if [ ! -d "$DISTDIR" ]; then
            echo "ERROR: Nuitka dist directory not found"
            exit 2
          fi

          # 为生成的可执行创建一个 .app 包（简单 Info.plist）
          APPNAME="MyNuitkaApp"
          APPDIR="dist/${APPNAME}.app"
          mkdir -p "${APPDIR}/Contents/MacOS"
          mkdir -p "${APPDIR}/Contents/Resources"

          # Nuitka 的可执行文件在 DISTDIR 下，通常名称与入口脚本相同（例如 main）
          # 尝试定位可执行文件
          BINFILE=$(find "$DISTDIR" -maxdepth 2 -type f -perm +111 -print | head -n1)
          if [ -z "$BINFILE" ]; then
            # 备用：查找名为 main 的可执行
            BINFILE=$(find "$DISTDIR" -type f -name "main" -print | head -n1)
          fi
          echo "Located binary: $BINFILE"
          if [ -z "$BINFILE" ]; then
            echo "No executable found in Nuitka dist. Listing DISTDIR:"
            ls -R "$DISTDIR"
            exit 3
          fi

          # 复制所有运行时文件到 App 的 MacOS 目录（Nuitka 的 standalone 可直接放在 Contents/MacOS）
          cp -R "$DISTDIR"/* "${APPDIR}/Contents/MacOS/"

          # 确保主可执行有可执行权限并位于 Contents/MacOS（保留名称）
          chmod +x "${APPDIR}/Contents/MacOS/"*

          # 生成简单 Info.plist
          cat > "${APPDIR}/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>${APPNAME}</string>
            <key>CFBundleIdentifier</key>
            <string>com.github.${APPNAME}</string>
            <key>CFBundleExecutable</key>
            <string>$(basename "$BINFILE")</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
          </dict>
          </plist>
          EOF

          # 打包为 zip 方便下载
          cd dist
          zip -r "${APPNAME}-macos-arm64.zip" "${APPNAME}.app"
          cd ..

      - name: List dist and artifact
        run: ls -lh dist || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: dist/*.zip
